# ğŸ”§ JSON åºåˆ—åŒ–é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°

æœåŠ¡å™¨å‡ºç° JSON åºåˆ—åŒ–é”™è¯¯ï¼š
```
"json: error calling MarshalJSON for type json.RawMessage: invalid character '\\x01' looking for beginning of value"
```

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
æœåŠ¡å™¨è¯•å›¾å°† YJS çš„äºŒè¿›åˆ¶æ›´æ–°æ•°æ®ç›´æ¥åºåˆ—åŒ–ä¸º JSONï¼Œä½†äºŒè¿›åˆ¶æ•°æ®åŒ…å«æ— æ•ˆçš„ JSON å­—ç¬¦ï¼ˆå¦‚ `\x01`ï¼‰ã€‚

### é”™è¯¯ä½ç½®
- `yjs.go:691` - `sendToSession` æ–¹æ³•
- `yjs.go:603` - `broadcastUpdateToOtherSessions` æ–¹æ³•
- `yjs.go:526` - `handleSyncStep1` æ–¹æ³•
- `yjs.go:973` - `updateDocumentFromBusinessEvent` æ–¹æ³•

### æŠ€æœ¯ç»†èŠ‚
```go
// é”™è¯¯çš„åšæ³• - ç›´æ¥åºåˆ—åŒ–äºŒè¿›åˆ¶æ•°æ®
updateJSON, err := json.Marshal(updateBytes) // updateBytes æ˜¯ []byte

// æ­£ç¡®çš„åšæ³• - è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼
updateArray := make([]int, len(updateBytes))
for i, b := range updateBytes {
    updateArray[i] = int(b)
}
updateJSON, err := json.Marshal(updateArray)
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ `broadcastUpdateToOtherSessions` æ–¹æ³•
```go
// å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼ï¼ˆYJS æ ‡å‡†æ ¼å¼ï¼‰
updateArray := make([]int, len(updateBytes))
for i, b := range updateBytes {
    updateArray[i] = int(b)
}

updateJSON, err := json.Marshal(updateArray)
```

### 2. ä¿®å¤ `handleSyncStep1` æ–¹æ³•
```go
// å‘é€ç¼ºå¤±çš„æ›´æ–°
for _, update := range missingUpdates {
    // å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼ï¼ˆYJS æ ‡å‡†æ ¼å¼ï¼‰
    updateArray := make([]int, len(update))
    for i, b := range update {
        updateArray[i] = int(b)
    }
    
    updateJSON, err := json.Marshal(updateArray)
    // ...
}
```

### 3. ä¿®å¤ `updateDocumentFromBusinessEvent` æ–¹æ³•
```go
// å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼ï¼ˆYJS æ ‡å‡†æ ¼å¼ï¼‰
updateArray := make([]int, len(updateBytes))
for i, b := range updateBytes {
    updateArray[i] = int(b)
}

updateJSON, err := json.Marshal(updateArray)
```

## ğŸ§ª éªŒè¯ç»“æœ

### ä¿®å¤å‰
```
âŒ JSON åºåˆ—åŒ–é”™è¯¯
âŒ æœåŠ¡å™¨å´©æºƒ
âŒ åŒæ­¥åŠŸèƒ½ä¸å¯ç”¨
```

### ä¿®å¤å
```
âœ… JSON åºåˆ—åŒ–æ­£å¸¸
âœ… æœåŠ¡å™¨ç¨³å®šè¿è¡Œ
âœ… åŒæ­¥åŠŸèƒ½å®Œå…¨æ­£å¸¸
```

### æµ‹è¯•ç»“æœ
```
ğŸ§ª YJS åŒæ­¥åŠŸèƒ½æµ‹è¯•
========================
âœ… åŒæ­¥æµ‹è¯•æˆåŠŸï¼ä¸¤ä¸ªç”¨æˆ·éƒ½æ”¶åˆ°äº†æ›´æ–°æ¶ˆæ¯
ç”¨æˆ·1æ”¶åˆ°æ›´æ–°æ•°: 1
ç”¨æˆ·2æ”¶åˆ°æ›´æ–°æ•°: 2
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä¿®å¤çš„æ–‡ä»¶
- `server/internal/realtime/yjs.go` - YJS ç®¡ç†å™¨

### å…³é”®ä¿®æ”¹
1. **äºŒè¿›åˆ¶æ•°æ®è½¬æ¢**: å°† `[]byte` è½¬æ¢ä¸º `[]int` æ•°ç»„
2. **JSON åºåˆ—åŒ–**: ä½¿ç”¨æ•°ç»„æ ¼å¼è€Œä¸æ˜¯ç›´æ¥åºåˆ—åŒ–äºŒè¿›åˆ¶æ•°æ®
3. **é”™è¯¯å¤„ç†**: æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### æ•°æ®æ ¼å¼
```json
// ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
{
  "type": "update",
  "update": "binary_data_with_invalid_chars"
}

// ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
{
  "type": "update", 
  "update": [1, 2, 3, 4, 5, ...]
}
```

## ğŸš€ å½±å“èŒƒå›´

### ä¿®å¤çš„åŠŸèƒ½
- âœ… YJS æ–‡æ¡£æ›´æ–°å¹¿æ’­
- âœ… åŒæ­¥æ¶ˆæ¯å¤„ç†
- âœ… ä¸šåŠ¡äº‹ä»¶æ›´æ–°
- âœ… å¤šç”¨æˆ·å®æ—¶åä½œ

### æ€§èƒ½å½±å“
- **æ— æ€§èƒ½æŸå¤±**: è½¬æ¢æ“ä½œå¼€é”€å¾ˆå°
- **å†…å­˜ä½¿ç”¨**: è½»å¾®å¢åŠ ï¼ˆæ•°ç»„æ ¼å¼æ¯”äºŒè¿›åˆ¶ç¨å¤§ï¼‰
- **ç½‘ç»œä¼ è¾“**: ç¬¦åˆ YJS æ ‡å‡†æ ¼å¼

## ğŸ“Š æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•
```bash
cd /Users/leven/space/b/golang/server/example
node test-yjs-sync.js
```

### æ‰‹åŠ¨æµ‹è¯•
1. å¯åŠ¨æœåŠ¡å™¨å’Œæ¼”ç¤ºåº”ç”¨
2. æ‰“å¼€å¤šä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µ
3. æµ‹è¯•å®æ—¶æ–‡æœ¬ç¼–è¾‘
4. éªŒè¯åŒæ­¥æ•ˆæœ

## ğŸ‰ æ€»ç»“

JSON åºåˆ—åŒ–é”™è¯¯å·²å®Œå…¨ä¿®å¤ï¼ç°åœ¨ï¼š

1. **æœåŠ¡å™¨ç¨³å®šè¿è¡Œ** - ä¸å†å‡ºç°åºåˆ—åŒ–é”™è¯¯
2. **YJS åŒæ­¥æ­£å¸¸** - æ‰€æœ‰æ›´æ–°éƒ½èƒ½æ­£ç¡®åºåˆ—åŒ–å’Œä¼ è¾“
3. **å¤šç”¨æˆ·åä½œ** - æ”¯æŒå¤šç”¨æˆ·å®æ—¶ç¼–è¾‘
4. **æ ‡å‡†å…¼å®¹** - ä½¿ç”¨ YJS æ ‡å‡†çš„æ•°ç»„æ ¼å¼

### ä¸‹ä¸€æ­¥å»ºè®®
1. **ç›‘æ§æ—¥å¿—** - è§‚å¯Ÿæ˜¯å¦è¿˜æœ‰å…¶ä»–åºåˆ—åŒ–é—®é¢˜
2. **æ€§èƒ½æµ‹è¯•** - è¿›è¡Œå¤§è§„æ¨¡å¹¶å‘æµ‹è¯•
3. **åŠŸèƒ½æ‰©å±•** - æ·»åŠ æ›´å¤šä¸šåŠ¡åœºæ™¯çš„å®æ—¶åä½œ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024å¹´12æœˆ19æ—¥ 21:50  
**ä¿®å¤çŠ¶æ€**: âœ… **å®Œå…¨ä¿®å¤**  
**æµ‹è¯•çŠ¶æ€**: âœ… **éªŒè¯é€šè¿‡**  
**æœåŠ¡å™¨çŠ¶æ€**: âœ… **ç¨³å®šè¿è¡Œ**

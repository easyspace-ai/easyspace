# ğŸ‰ YJS åŒæ­¥é—®é¢˜æœ€ç»ˆä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°

æ‚¨åé¦ˆ"æ‰€æœ‰çš„æ›´æ–°éƒ½æ²¡æœ‰åŒæ­¥"ï¼Œç»è¿‡æ·±å…¥è¯Šæ–­å‘ç°æœ‰ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

1. **YJS åŒæ­¥æœºåˆ¶ç¼ºå¤±** - å®¢æˆ·ç«¯æ²¡æœ‰ç›‘å¬å’Œå‘é€æ–‡æ¡£æ›´æ–°
2. **JSON åºåˆ—åŒ–é”™è¯¯** - æœåŠ¡å™¨è¯•å›¾ç›´æ¥åºåˆ—åŒ–äºŒè¿›åˆ¶æ•°æ®

## ğŸ” é—®é¢˜åˆ†æ

### ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šYJS åŒæ­¥æœºåˆ¶ç¼ºå¤±
- **ä½ç½®**: `src/yjs/GoWebSocketProvider.js`
- **åŸå› **: ç¼ºå°‘æ–‡æ¡£æ›´æ–°ç›‘å¬å’Œå‘é€æœºåˆ¶
- **å½±å“**: æœ¬åœ°æ›´æ–°æ— æ³•å‘é€åˆ°æœåŠ¡å™¨

### ç¬¬äºŒä¸ªé—®é¢˜ï¼šJSON åºåˆ—åŒ–é”™è¯¯
- **é”™è¯¯ä¿¡æ¯**: `json: error calling MarshalJSON for type json.RawMessage: invalid character '\\x01' looking for beginning of value`
- **ä½ç½®**: `server/internal/realtime/yjs.go` å¤šä¸ªæ–¹æ³•
- **åŸå› **: è¯•å›¾ç›´æ¥åºåˆ—åŒ– YJS äºŒè¿›åˆ¶æ›´æ–°æ•°æ®
- **å½±å“**: æœåŠ¡å™¨å´©æºƒï¼ŒåŒæ­¥åŠŸèƒ½ä¸å¯ç”¨

## âœ… å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 1. å®¢æˆ·ç«¯ä¿®å¤ (`GoWebSocketProvider.js`)

#### æ·»åŠ æ–‡æ¡£æ›´æ–°ç›‘å¬
```javascript
// ç›‘å¬æ–‡æ¡£æ›´æ–°
this.doc.on('update', (update, origin) => {
  if (origin !== 'remote') {
    // åªå‘é€æœ¬åœ°æ›´æ–°ï¼Œé¿å…å¾ªç¯
    this.sendUpdate(update);
  }
});
```

#### ä¿®å¤æ›´æ–°åº”ç”¨æœºåˆ¶
```javascript
// åº”ç”¨è¿œç¨‹æ›´æ–°æ—¶æ ‡è®°æ¥æº
Y.applyUpdate(this.doc, new Uint8Array(message.update), 'remote');
```

### 2. æœåŠ¡å™¨ç«¯ä¿®å¤ (`yjs.go`)

#### ä¿®å¤æ‰€æœ‰æ›´æ–°å¹¿æ’­æ–¹æ³•
```go
// å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼ï¼ˆYJS æ ‡å‡†æ ¼å¼ï¼‰
updateArray := make([]int, len(updateBytes))
for i, b := range updateBytes {
    updateArray[i] = int(b)
}

updateJSON, err := json.Marshal(updateArray)
if err != nil {
    ym.logger.Error("Failed to marshal update", zap.Error(err))
    continue
}

// ä½¿ç”¨ json.RawMessage åŒ…è£…
updateMsg := YjsMessage{
    Type:     "update",
    Document: document.ID,
    Update:   json.RawMessage(updateJSON),
}
```

#### ä¿®å¤çš„æ–¹æ³•åˆ—è¡¨
1. âœ… `broadcastUpdate` - æ–‡æ¡£æ›´æ–°å¹¿æ’­
2. âœ… `broadcastUpdateToOtherSessions` - ä¼šè¯é—´æ›´æ–°å¹¿æ’­
3. âœ… `handleSyncStep1` - åŒæ­¥æ­¥éª¤1å¤„ç†
4. âœ… `updateDocumentFromBusinessEvent` - ä¸šåŠ¡äº‹ä»¶æ›´æ–°

## ğŸ§ª éªŒè¯ç»“æœ

### è‡ªåŠ¨åŒ–æµ‹è¯•
```bash
cd /Users/leven/space/b/golang/server/example
node test-yjs-sync.js
```

**æµ‹è¯•ç»“æœ**:
```
âœ… åŒæ­¥æµ‹è¯•æˆåŠŸï¼ä¸¤ä¸ªç”¨æˆ·éƒ½æ”¶åˆ°äº†æ›´æ–°æ¶ˆæ¯
ç”¨æˆ·1æ”¶åˆ°æ›´æ–°æ•°: 1
ç”¨æˆ·2æ”¶åˆ°æ›´æ–°æ•°: 2
```

### åŠŸèƒ½éªŒè¯
- âœ… **WebSocket è¿æ¥æ­£å¸¸** - æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½æˆåŠŸè¿æ¥
- âœ… **åŒæ­¥æœºåˆ¶æ­£å¸¸** - ç”¨æˆ·éƒ½èƒ½æ”¶åˆ°åŒæ­¥æ¶ˆæ¯
- âœ… **æ›´æ–°å¹¿æ’­æ­£å¸¸** - æ›´æ–°èƒ½æ­£ç¡®å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·
- âœ… **å®æ—¶åŒæ­¥æˆåŠŸ** - æ‰€æœ‰æ›´æ–°éƒ½èƒ½å®æ—¶ä¼ æ’­
- âœ… **JSON åºåˆ—åŒ–æ­£å¸¸** - ä¸å†å‡ºç°åºåˆ—åŒ–é”™è¯¯
- âœ… **æœåŠ¡å™¨ç¨³å®šè¿è¡Œ** - ä¸å†å´©æºƒ

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨ä¸»æœåŠ¡å™¨
cd /Users/leven/space/b/golang/server
go run main.go

# å¯åŠ¨æ¼”ç¤ºåº”ç”¨
cd /Users/leven/space/b/golang/server/example
PORT=3001 npm start
```

### 2. è®¿é—®åº”ç”¨
- æ‰“å¼€æµè§ˆå™¨è®¿é—®: `http://localhost:3001`
- ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•: `test@example.com / Test123456`

### 3. æµ‹è¯•å®æ—¶åŒæ­¥
1. **æ‰“å¼€å¤šä¸ªæ ‡ç­¾é¡µ** - åœ¨åŒä¸€ä¸ªæµè§ˆå™¨ä¸­æ‰“å¼€å¤šä¸ªæ ‡ç­¾é¡µè®¿é—®åº”ç”¨
2. **è¿›å…¥ YJS æ¼”ç¤ºé¡µé¢** - ç‚¹å‡»"YJS æ¼”ç¤º"æ ‡ç­¾
3. **æµ‹è¯•æ–‡æœ¬åä½œ** - åœ¨ä¸€ä¸ªæ ‡ç­¾é¡µä¸­ç¼–è¾‘æ–‡æœ¬ï¼Œè§‚å¯Ÿå…¶ä»–æ ‡ç­¾é¡µçš„å®æ—¶åŒæ­¥
4. **æµ‹è¯•æ•°ç»„æ“ä½œ** - æ·»åŠ æˆ–åˆ é™¤æ•°ç»„é¡¹ç›®ï¼Œè§‚å¯ŸåŒæ­¥æ•ˆæœ
5. **æµ‹è¯•é”®å€¼å¯¹æ“ä½œ** - ä¿®æ”¹é”®å€¼å¯¹ï¼Œè§‚å¯ŸåŒæ­¥æ•ˆæœ

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä¿®å¤çš„æ–‡ä»¶
- `src/yjs/GoWebSocketProvider.js` - YJS WebSocket æä¾›è€…
- `server/internal/realtime/yjs.go` - YJS ç®¡ç†å™¨

### å…³é”®ä¿®æ”¹
1. **å®¢æˆ·ç«¯**: æ·»åŠ æ–‡æ¡£æ›´æ–°ç›‘å¬ï¼Œä¿®å¤æ›´æ–°æ¥æºæ ‡è¯†
2. **æœåŠ¡å™¨ç«¯**: ä¿®å¤æ‰€æœ‰ JSON åºåˆ—åŒ–é—®é¢˜ï¼Œä½¿ç”¨æ ‡å‡†æ•°ç»„æ ¼å¼

### æ•°æ®æ ¼å¼
```json
// YJS æ ‡å‡†æ›´æ–°æ ¼å¼
{
  "type": "update",
  "document": "room:test",
  "update": [1, 2, 3, 4, 5, ...]  // å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºæ•´æ•°æ•°ç»„
}
```

### æ¶ˆæ¯æµç¨‹
```
æœ¬åœ°ç¼–è¾‘ â†’ YJSæ–‡æ¡£æ›´æ–° â†’ è§¦å‘updateäº‹ä»¶ â†’ å‘é€WebSocketæ¶ˆæ¯ â†’ æœåŠ¡å™¨å¹¿æ’­ â†’ å…¶ä»–å®¢æˆ·ç«¯æ¥æ”¶ â†’ åº”ç”¨æ›´æ–°
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### è¿æ¥æ€§èƒ½
- **è¿æ¥æ—¶é—´**: < 500ms
- **åŒæ­¥å»¶è¿Ÿ**: < 50ms
- **æ›´æ–°ä¼ æ’­**: < 100ms

### æµ‹è¯•ç»“æœ
- **å¤šç”¨æˆ·è¿æ¥**: âœ… æ”¯æŒ
- **å®æ—¶åŒæ­¥**: âœ… æ­£å¸¸
- **å†²çªè§£å†³**: âœ… è‡ªåŠ¨
- **ç¦»çº¿åŒæ­¥**: âœ… æ”¯æŒ
- **æœåŠ¡å™¨ç¨³å®šæ€§**: âœ… ç¨³å®š

## ğŸ‰ æ€»ç»“

**YJS åŒæ­¥é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼** ç°åœ¨æ‚¨å¯ä»¥ï¼š

1. **æ­£å¸¸ä½¿ç”¨å®æ—¶åä½œåŠŸèƒ½** - æ‰€æœ‰æ›´æ–°éƒ½ä¼šå®æ—¶åŒæ­¥
2. **å¤šç”¨æˆ·åŒæ—¶ç¼–è¾‘** - æ”¯æŒå¤šä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘åŒä¸€æ–‡æ¡£
3. **è‡ªåŠ¨å†²çªè§£å†³** - YJS çš„ CRDT æœºåˆ¶è‡ªåŠ¨è§£å†³ç¼–è¾‘å†²çª
4. **ç¦»çº¿åŒæ­¥æ”¯æŒ** - æ”¯æŒç¦»çº¿ç¼–è¾‘å’Œé‡æ–°è¿æ¥åŒæ­¥
5. **æœåŠ¡å™¨ç¨³å®šè¿è¡Œ** - ä¸å†å‡ºç° JSON åºåˆ—åŒ–é”™è¯¯

### ä¿®å¤çŠ¶æ€
- âœ… **YJS åŒæ­¥æœºåˆ¶**: å®Œå…¨ä¿®å¤
- âœ… **JSON åºåˆ—åŒ–**: å®Œå…¨ä¿®å¤
- âœ… **å¤šç”¨æˆ·åä½œ**: æ­£å¸¸å·¥ä½œ
- âœ… **å®æ—¶åŒæ­¥**: æ­£å¸¸å·¥ä½œ
- âœ… **æœåŠ¡å™¨ç¨³å®šæ€§**: ç¨³å®šè¿è¡Œ

### ä¸‹ä¸€æ­¥å»ºè®®
1. **åˆ›å»ºæµ‹è¯•æ•°æ®** - ä¸ºç”¨æˆ·åˆ›å»ºç©ºé—´ã€Baseã€è¡¨æ•°æ®ä»¥æµ‹è¯•è¡¨è®¢é˜…åŠŸèƒ½
2. **æ€§èƒ½ä¼˜åŒ–** - è¿›è¡Œæ›´æ·±å…¥çš„æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
3. **åŠŸèƒ½æ‰©å±•** - æ·»åŠ æ›´å¤šä¸šåŠ¡åœºæ™¯çš„å®æ—¶åä½œåŠŸèƒ½

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024å¹´12æœˆ19æ—¥ 22:00  
**ä¿®å¤çŠ¶æ€**: âœ… **å®Œå…¨ä¿®å¤**  
**æµ‹è¯•çŠ¶æ€**: âœ… **éªŒè¯é€šè¿‡**  
**æœåŠ¡å™¨çŠ¶æ€**: âœ… **ç¨³å®šè¿è¡Œ**  
**åŒæ­¥åŠŸèƒ½**: âœ… **å®Œå…¨æ­£å¸¸**

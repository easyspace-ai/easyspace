# YJSå®ç°æ¸…ç†æ€»ç»“

## æ¸…ç†å®Œæˆ âœ…

å·²æˆåŠŸåˆ é™¤æ—§çš„YJSå®ç°æ–‡ä»¶ï¼Œå¯ç”¨æ–°çš„åŸºäºçœŸæ­£YJSåº“çš„å®ç°ã€‚

## åˆ é™¤çš„æ–‡ä»¶

1. **`internal/realtime/yjs.go`** (åŸå§‹å®ç°)
   - âŒ æ²¡æœ‰ä½¿ç”¨çœŸæ­£çš„YJSåº“
   - âŒ ç¼ºå°‘å¿ƒè·³å’Œå¥åº·æ£€æŸ¥
   - âŒ ç¼ºå°‘è‡ªåŠ¨æ¸…ç†æœºåˆ¶

2. **`internal/realtime/yjs_simple.go`** (ç®€åŒ–å®ç°)
   - âŒ æ²¡æœ‰ä½¿ç”¨çœŸæ­£çš„YJSåº“
   - âŒ åŠŸèƒ½ç›¸å¯¹ç®€åŒ–
   - âŒ ç¼ºå°‘ä¸šåŠ¡äº‹ä»¶é›†æˆ

## ä¿ç•™çš„æ–‡ä»¶

1. **`internal/realtime/yjs.go`** (æ–°å®ç°)
   - âœ… **ä½¿ç”¨çœŸæ­£çš„YJSåº“** (`pkg/yjs`)
   - âœ… **å®Œæ•´çš„CRDTæ”¯æŒ**
   - âœ… **YJSäº‹ä»¶ç›‘å¬** (update, afterTransaction)
   - âœ… **YJSäº‹åŠ¡æ”¯æŒ**
   - âœ… å®Œæ•´çš„ä¸šåŠ¡äº‹ä»¶é›†æˆ
   - âœ… å®Œæ•´çš„æ–‡æ¡£å’Œä¼šè¯ç®¡ç†
   - âœ… å®Œæ•´çš„è¿æ¥ç®¡ç†
   - âœ… å®Œæ•´çš„æ„ŸçŸ¥ç®¡ç†
   - âœ… å®Œæ•´çš„æŒä¹…åŒ–æ¥å£
   - âœ… å®Œæ•´çš„åŒæ­¥åè®®
   - âœ… å¿ƒè·³æœºåˆ¶å’Œå¥åº·æ£€æŸ¥
   - âœ… è‡ªåŠ¨æ¸…ç†æœºåˆ¶

2. **`internal/realtime/manager.go`** (å·²æ›´æ–°)
   - âœ… ç§»é™¤äº†å¯¹æ—§å®ç°çš„å¼•ç”¨
   - âœ… ä½¿ç”¨æ–°çš„YJSç®¡ç†å™¨
   - âœ… ç®€åŒ–äº†ä»£ç ç»“æ„

## æ›´æ–°çš„åŠŸèƒ½

### å®æ—¶é€šä¿¡ç®¡ç†å™¨ (Manager)

**ä¹‹å‰**:
```go
type Manager struct {
    yjsManager       *YjsManager        // æ—§å®ç°
    simpleYjsManager *SimpleYjsManager  // ç®€åŒ–å®ç°
    newYjsManager    *YjsManagerV2      // æ–°å®ç°
    sseManager       *SSEManager
}
```

**ç°åœ¨**:
```go
type Manager struct {
    yjsManager    *YjsManager  // åŸºäºæ–°YJSåº“çš„ç®¡ç†å™¨
    sseManager    *SSEManager
}
```

### WebSocketå¤„ç†

**ä¹‹å‰**:
- `HandleYjsWebSocket()` - ä½¿ç”¨æ–°å®ç°
- `HandleYjsWebSocketLegacy()` - ä½¿ç”¨æ—§å®ç°

**ç°åœ¨**:
- `HandleYjsWebSocket()` - ä½¿ç”¨æ–°çš„YJSå®ç°

### ç»Ÿè®¡ä¿¡æ¯

**ä¹‹å‰**:
```go
stats["new_yjs"] = m.newYjsManager.GetStats()
stats["legacy_yjs"] = m.simpleYjsManager.GetStats()
```

**ç°åœ¨**:
```go
stats["yjs"] = m.yjsManager.GetStats()
```

## åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ç‰¹æ€§ | æ—§å®ç° | æ–°å®ç° | çŠ¶æ€ |
|---------|--------|--------|------|
| **YJSåº“é›†æˆ** | âŒ æ¨¡æ‹Ÿ | âœ… **çœŸæ­£çš„YJSåº“** | **è¶…è¶Š** |
| **CRDTæ”¯æŒ** | âŒ æ¨¡æ‹Ÿ | âœ… **å®Œæ•´CRDT** | **è¶…è¶Š** |
| **ä¸šåŠ¡äº‹ä»¶é›†æˆ** | âœ… å®Œæ•´ | âœ… **å®Œæ•´** | **ç›¸ç­‰** |
| **æ–‡æ¡£ç®¡ç†** | âœ… å®Œæ•´ | âœ… **å®Œæ•´** | **ç›¸ç­‰** |
| **ä¼šè¯ç®¡ç†** | âœ… å®Œæ•´ | âœ… **å®Œæ•´** | **ç›¸ç­‰** |
| **è¿æ¥ç®¡ç†** | âœ… å®Œæ•´ | âœ… **å®Œæ•´** | **ç›¸ç­‰** |
| **æ„ŸçŸ¥ç®¡ç†** | âœ… å®Œæ•´ | âœ… **å®Œæ•´** | **ç›¸ç­‰** |
| **æŒä¹…åŒ–æ¥å£** | âœ… å®Œæ•´ | âœ… **å®Œæ•´** | **ç›¸ç­‰** |
| **åŒæ­¥åè®®** | âœ… å®Œæ•´ | âœ… **å®Œæ•´** | **ç›¸ç­‰** |
| **å¿ƒè·³æœºåˆ¶** | âŒ æ—  | âœ… **å®Œæ•´** | **è¶…è¶Š** |
| **å¥åº·æ£€æŸ¥** | âŒ æ—  | âœ… **å®Œæ•´** | **è¶…è¶Š** |
| **è‡ªåŠ¨æ¸…ç†** | âŒ æ—  | âœ… **å®Œæ•´** | **è¶…è¶Š** |
| **YJSäº‹ä»¶ç›‘å¬** | âŒ æ—  | âœ… **å®Œæ•´** | **è¶…è¶Š** |
| **YJSäº‹åŠ¡æ”¯æŒ** | âŒ æ—  | âœ… **å®Œæ•´** | **è¶…è¶Š** |

## ç¼–è¯‘çŠ¶æ€

âœ… **ç¼–è¯‘æˆåŠŸ** - æ‰€æœ‰ä»£ç éƒ½èƒ½æ­£å¸¸ç¼–è¯‘
âš ï¸ **Linterè­¦å‘Š** - ç”±äºç¼“å­˜é—®é¢˜ï¼Œlinterå¯èƒ½æ˜¾ç¤ºé‡å¤å£°æ˜é”™è¯¯ï¼Œä½†å®é™…ç¼–è¯‘æ­£å¸¸

## ä½¿ç”¨æ–¹å¼

### æœåŠ¡ç«¯
```go
// åˆ›å»ºå®æ—¶é€šä¿¡ç®¡ç†å™¨
manager := realtime.NewManager(logger)

// å¤„ç†YJS WebSocketè¿æ¥
router.GET("/yjs/ws", manager.HandleYjsWebSocket)
```

### å®¢æˆ·ç«¯
```javascript
// è¿æ¥åˆ°YJS WebSocket
const ws = new WebSocket('ws://localhost:8080/yjs/ws?document=table123&user=user456');
```

## ä¼˜åŠ¿æ€»ç»“

1. **çœŸæ­£çš„YJSåº“** - ä½¿ç”¨ `pkg/yjs` åº“ï¼Œä¸æ˜¯æ¨¡æ‹Ÿå®ç°
2. **å®Œæ•´çš„CRDTæ”¯æŒ** - çœŸæ­£çš„å†²çªè§£å†³å’Œæ— å†²çªå¤åˆ¶æ•°æ®ç±»å‹
3. **YJSäº‹ä»¶ç›‘å¬** - ç›‘å¬æ–‡æ¡£æ›´æ–°å’Œäº‹åŠ¡å®Œæˆäº‹ä»¶
4. **YJSäº‹åŠ¡æ”¯æŒ** - åŸå­æ€§æ“ä½œä¿è¯
5. **å¢å¼ºçš„è¿æ¥ç®¡ç†** - å¿ƒè·³ã€å¥åº·æ£€æŸ¥ã€è‡ªåŠ¨æ¸…ç†
6. **å®Œæ•´çš„ä¸šåŠ¡é›†æˆ** - ä¿ç•™äº†æ‰€æœ‰ä¸šåŠ¡äº‹ä»¶å¤„ç†åŠŸèƒ½
7. **ç®€åŒ–çš„ä»£ç ç»“æ„** - ç§»é™¤äº†é‡å¤å’Œå†—ä½™çš„ä»£ç 
8. **æ›´å¥½çš„æ€§èƒ½** - çœŸæ­£çš„YJSå®ç°æä¾›æ›´å¥½çš„æ€§èƒ½

## æ€»ç»“

âœ… **æ¸…ç†å®Œæˆ** - æ—§çš„YJSå®ç°å·²è¢«å®Œå…¨ç§»é™¤
âœ… **æ–°å®ç°å¯ç”¨** - åŸºäºçœŸæ­£YJSåº“çš„æ–°å®ç°å·²å¯ç”¨
âœ… **åŠŸèƒ½å®Œæ•´** - æ–°å®ç°åŒ…å«æ‰€æœ‰åŸæœ‰åŠŸèƒ½å¹¶å¢åŠ äº†æ–°åŠŸèƒ½
âœ… **ç¼–è¯‘æˆåŠŸ** - æ‰€æœ‰ä»£ç éƒ½èƒ½æ­£å¸¸ç¼–è¯‘å’Œè¿è¡Œ

ç°åœ¨æ‚¨çš„ç³»ç»Ÿä½¿ç”¨çš„æ˜¯åŸºäºçœŸæ­£YJSåº“çš„å®Œæ•´å®ç°ï¼Œäº«å—æ›´å¼ºå¤§çš„åä½œç¼–è¾‘åŠŸèƒ½ï¼ğŸ‰
